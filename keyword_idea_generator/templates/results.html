{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card">
        <div class="card-body">
            <h2 class="card-title mb-4">
                <i class="fas fa-chart-bar me-2"></i>
                Resultados del Análisis
            </h2>
            
            <!-- Pestañas para diferentes tipos de resultados -->
            <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="autocomplete-tab" data-bs-toggle="tab" href="#autocomplete" role="tab">
                        <i class="fas fa-search me-2"></i>
                        Google Autocomplete
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="paa-tab" data-bs-toggle="tab" href="#paa" role="tab">
                        <i class="fas fa-question-circle me-2"></i>
                        People Also Ask
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="trends-tab" data-bs-toggle="tab" href="#trends" role="tab">
                        <i class="fas fa-chart-line me-2"></i>
                        Google Trends
                    </a>
                </li>
            </ul>

            <!-- Contenido de las pestañas -->
            <div class="tab-content mt-4" id="resultsContent">
                <!-- Google Autocomplete -->
                <div class="tab-pane fade show active" id="autocomplete" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover" id="autocompleteTable">
                            <thead>
                                <tr>
                                    <th>Palabra Clave</th>
                                    <th>Búsqueda Mensual</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for keyword in autocomplete_keywords %}
                                <tr>
                                    <td>{{ keyword.term }}</td>
                                    <td>{{ keyword.volume if keyword.volume else 'N/A' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary save-keyword" 
                                                data-keyword="{{ keyword.term }}"
                                                data-type="autocomplete">
                                            <i class="fas fa-bookmark me-1"></i>
                                            Guardar
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- People Also Ask -->
                <div class="tab-pane fade" id="paa" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover" id="paaTable">
                            <thead>
                                <tr>
                                    <th>Pregunta</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for question in paa_questions %}
                                <tr>
                                    <td>{{ question }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary save-keyword"
                                                data-keyword="{{ question }}"
                                                data-type="paa">
                                            <i class="fas fa-bookmark me-1"></i>
                                            Guardar
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Google Trends -->
                <div class="tab-pane fade" id="trends" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover" id="trendsTable">
                            <thead>
                                <tr>
                                    <th>Término Relacionado</th>
                                    <th>Puntuación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trend in trends_keywords %}
                                <tr>
                                    <td>{{ trend.term }}</td>
                                    <td>{{ trend.score }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary save-keyword"
                                                data-keyword="{{ trend.term }}"
                                                data-type="trends">
                                            <i class="fas fa-bookmark me-1"></i>
                                            Guardar
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="mt-4 d-flex justify-content-between">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Volver
                </a>
                <div>
                    <button class="btn btn-success me-2" id="exportAllBtn">
                        <i class="fas fa-file-export me-2"></i>
                        Exportar Todo
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>
                            Exportar Selección
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item export-btn" href="#" data-type="autocomplete">
                                    <i class="fas fa-search me-2"></i>
                                    Google Autocomplete
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item export-btn" href="#" data-type="paa">
                                    <i class="fas fa-question-circle me-2"></i>
                                    People Also Ask
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item export-btn" href="#" data-type="trends">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Google Trends
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">Notificación</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css"/>

<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar DataTables
    const tables = {
        autocomplete: $('#autocompleteTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
            },
            pageLength: 10,
            dom: 'Bfrtip',
            order: [[0, 'asc']]
        }),
        paa: $('#paaTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
            },
            pageLength: 10,
            dom: 'Bfrtip',
            order: [[0, 'asc']]
        }),
        trends: $('#trendsTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
            },
            pageLength: 10,
            dom: 'Bfrtip',
            order: [[0, 'asc']]
        })
    };

    // Función para mostrar notificaciones
    function showToast(title, message, success = true) {
        $('#toastTitle').text(title);
        $('#toastMessage').text(message);
        $('#toast').removeClass('bg-success bg-danger')
            .addClass(success ? 'bg-success' : 'bg-danger')
            .toast('show');
    }

    // Guardar keyword
    $('.save-keyword').click(function() {
        const keyword = $(this).data('keyword');
        const type = $(this).data('type');
        
        $.ajax({
            url: '/save_keyword',
            method: 'POST',
            data: {
                keyword: keyword,
                type: type
            },
            success: function(response) {
                showToast('Éxito', 'Palabra clave guardada correctamente');
            },
            error: function() {
                showToast('Error', 'No se pudo guardar la palabra clave', false);
            }
        });
    });

    // Exportar a CSV
    function exportToCSV(type) {
        $.ajax({
            url: '/export',
            method: 'POST',
            data: { type: type },
            success: function(response) {
                const blob = new Blob([response], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `keywords_${type}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showToast('Éxito', 'Archivo exportado correctamente');
            },
            error: function() {
                showToast('Error', 'No se pudo exportar el archivo', false);
            }
        });
    }

    // Botones de exportación
    $('.export-btn').click(function(e) {
        e.preventDefault();
        const type = $(this).data('type');
        exportToCSV(type);
    });

    // Exportar todo
    $('#exportAllBtn').click(function() {
        exportToCSV('all');
    });
});
</script>
{% endblock %}
